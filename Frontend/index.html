<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>MedWay Emergency Routing</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
body { margin:0; background:#000; color:#fff; font-family:Arial; }
#panel { padding:10px; background:#111; }
#map { height:85vh; }
#info { margin-top:10px; line-height:1.6; }
</style>
</head>

<body>

<div id="panel">
<b>Severity:</b>
<select id="severity">
  <option>LOW</option>
  <option>MEDIUM</option>
  <option>HIGH</option>
</select>
<div id="info">Click on map to place patient</div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
const map = L.map("map").setView([26.9124, 75.7873], 12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let patientMarker, ambMarker, hospMarker, ambLine, hospLine;

map.on("click", async e => {
  clearMap();

  patientMarker = L.marker(e.latlng).addTo(map).bindPopup("Patient").openPopup();

  const res = await fetch("http://127.0.0.1:8000/route", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({
      patient_lat: e.latlng.lat,
      patient_lon: e.latlng.lng,
      severity: document.getElementById("severity").value
    })
  });

  const data = await res.json();

  ambMarker = L.marker([data.ambulance.lat, data.ambulance.lon])
    .addTo(map)
    .bindPopup(`Ambulance: ${data.ambulance.id}`);

  hospMarker = L.marker([data.best_hospital.lat, data.best_hospital.lon])
    .addTo(map)
    .bindPopup(`Hospital: ${data.best_hospital.name}`);

  ambLine = L.polyline(data.routes.ambulance_to_patient,
    {color:"blue", dashArray:"6,8", weight:4}).addTo(map);

  hospLine = L.polyline(data.routes.patient_to_hospital,
    {color:"red", weight:5}).addTo(map);

  map.fitBounds(hospLine.getBounds());

  let hospitalList = "<b>Hospital Ranking:</b><br>";
  data.hospital_options.forEach((h, i) => {
    hospitalList += `${i+1}. ${h.name} | ETA ${h.eta_min} min | Beds ${h.beds}<br>`;
  });

  document.getElementById("info").innerHTML = `
    <b>Ambulance:</b> ${data.ambulance.id} (${data.ambulance.type})<br>
    <b>Ambulance → Patient ETA:</b> ${data.ambulance.eta_min} min<br>
    <b>Selected Hospital:</b> ${data.best_hospital.name}<br>
    <b>Patient → Hospital ETA:</b> ${data.eta_to_hospital_min} min<br><br>
    ${hospitalList}
  `;
});

function clearMap(){
  [patientMarker, ambMarker, hospMarker, ambLine, hospLine].forEach(x=>{
    if(x) map.removeLayer(x);
  });
}
</script>

</body>
</html>
